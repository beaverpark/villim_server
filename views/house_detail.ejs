<!DOCTYPE html>
<html>
  <%- include('header') -%>

  <!-- swiper js,css -->
  <link rel="stylesheet" href="/swiper/css/swiper.min.css">
  <script src="/swiper/js/swiper.jquery.min.js"></script>
  <!-- else  swiper.min.js -->

  <!-- Star rating js, css -->
  <script src="/jquery_rating/jquery.barrating.min.js"></script>
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <link rel="stylesheet" href="/jquery_rating/themes/fontawesome-stars-o.css">

  <!-- Date picker js,css -->
  <link rel="stylesheet" href="/flat_pickr/themes/material_red.css">
  <script src="/flat_pickr/flatpickr.min.js"></script>

  <!-- Moment js -->
  <script src="/moment/moment.min.js"></script> 

  <style>
  </style>


  <style>
  	/* duplicate */
	.br-theme-fontawesome-stars-o .br-widget a.br-fractional:after, 
	.br-theme-fontawesome-stars-o .br-widget a.br-selected:after 
	{
	  color: crimson !important;
	}


	@media screen and (min-width: 580px) {
		body .swiper-container {
			height: 400px;
		}
	}


	@media screen and (min-width: 980px) {
		body .swiper-container {
			height: 500px;
		}
	}

	/* TODO: 여기서 search box 위로 옮기기 */
	@media screen and (min-width: 1320px) {
		body .swiper-container {
			height: 650px;
		}
	}

  	.swiper-container {
  		width: 100%;
  		height: 300px;
  	}

	.container.index_container.house_container .col {
		padding: 0;
	}
  /*	section#house_pics .swiper-wrapper {
  		height: auto;
  	}

  	section#house_pics .swiper-slide {
  		height: auto;
  	}*/


  	section.detail_section {
  		/*position: relative;*/
  		padding: 16px 0;
  		border-bottom: 1px solid #cdcdd1;
  		font-size: 16px;
  	}

  	section.detail_section:after {
/*  		position:absolute;
		content: "";
		display:block;
		width: 60%;
		border-bottom: 1px solid #cdcdd1;*/
 	}

  	section.detail_section .title {
  		font-weight: 600;
  	}

  	section.detail_section .content p {
  		margin: 2px 0;
  	}

/*
  	section#house_summary, section#house_description, section#house_policy, section#house_amenities, section#house_refund_policy {
  		width: 66%;
  	}
*/

  	section#house_pics .swiper-slide {
  		/*background-color: lightgray;*/
  		background-position: center;
  		background-size: cover;
  		background-repeat: no-repeat;
  		/*width: 600px;*/
  		/*width: auto;*/
  		/*height: auto;*/
  	}

  	section#house_intro .house_title {
  		font-family: "nanum_myeongjo";
  		text-align: center;
  		/*border-bottom: 1px solid #cdcdd1;*/
  		padding: 30px 0;
  	}

  	section#house_intro .house_title span {
  		color: rgba(0,0,0,0.7);
  		font-size: 34px;
  	}

  	section#house_summary .house_summary_content {
		/*border-top: 1px solid rgb(205, 205, 209);*/
		/*padding-top: 20px;*/
		font-size: 16px;
  	}


  	section#house_summary .col {
  		padding: 10px 0;

  	}

	section#house_summary .house_summary_content img {
	  height: 20px;
	}

	section#house_summary .house_summary_content .capacity {
		/*text-align: center;*/
		/*float: right;*/
	}

	section#house_amenities .amenity_item {
		padding-bottom: 20px;
	}

	section#house_amenities .amenity_item img {
		width: 30px;
		height: 20px;
		vertical-align: middle;
	}

	/* duplicate */
	.capacity_item {
		display: inline-block;
		width: 80px;
		text-align: center;
	}

/* Placeholder css */
  ::-webkit-input-placeholder { /* WebKit, Blink, Edge */
    color: black;
    opacity: 0.5;
  }
  :-moz-placeholder { /* Mozilla Firefox 4 to 18 */
    color: black;
    opacity: 0.5;
  }
  ::-moz-placeholder { /* Mozilla Firefox 19+ */
    color: black;
    opacity: 0.5;
  }
  :-ms-input-placeholder { /* Internet Explorer 10-11 */
    color: black;
    opacity: 0.5;
  }
  ::-ms-input-placeholder { /* Microsoft Edge */
    color: black;
    opacity: 0.5;
  }


	section#house_intro .card.search_bar {
		width: 300px;
		position:absolute;
		top: 168px;
		right: 0;
		margin: 0;
		padding: 44px 30px;
		box-shadow: none;
  		border: 1px solid #cdcdd1;
		border-radius: 1px;
	}

	section#house_intro .card.search_bar input {
		margin: 10px 0;
	    height: 40px;
		padding-left: 5px;
		margin: 10px 0;
	}


	section#house_intro .card.search_bar button {
		width: 100%;
		margin: 24px 0;
	}



  </style>

  <body>
    <!-- navbar -->
    <%- include('navbar') -%>
    <section id="house_pics" class="detail_section" style="padding: 0">
    	<div class="swiper-container">
    		<div class="swiper-wrapper">
    			<% for(var i = 0; i < house_pics_list.length; i++) { %>
    			<div class="swiper-slide" style="background-image:url(<%-house_pics_list[i].image-%>)"></div>
    			<% } %>
    		</div>
    		<!-- pagination -->
    		<div class="swiper-pagination"></div>
    		<!-- arrows -->
    		<div class="swiper-button-next"></div>
    		<div class="swiper-button-prev"></div>
    	</div>
    </section>

	<div class="container index_container house_container" style="position:relative">
	    <section id="house_intro" class="detail_section" >
  			<div class="house_title">
				<span class="text_thick"> <%- house_info.house_name -%> </span>
				<script>
					var rating = <%- house_info.house_rating -%>
				</script>
				 <select class="star_rating" id="star_rating">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                  </select>
	  		</div>
			<div class="card search_bar">
				<div class="row">
				  <form action="/checkout" method="post">
				    <div class="input-field col s12">
				      <input placeholder="체크인" id="checkin_date_picker" name="checkin" type="text" required>
				    </div>
				    <div class="input-field col s12">
				      <input placeholder="체크아웃" id="checkout_date_picker" name="checkout" type="text" required>
				      <div class="price">
  			      		  <div class="total_price"></div>
		      		  </div>
				    </div>
				    <div class="col s12"> 
				      <button class="btn waves-effect waves-light red accent-2" type="submit">예약하기</button>
				    </div>
				    <input name="house_id" type="hidden" value="<%- house_id -%>">
				  </form>
				</div>
			</div>
	  	</section>
	  	<section id="house_summary" class="detail_section">
  			<div class="house_summary_content">
			    <div class="row">
					<div class="col s12 m6 l6">
						<span> <%- house_info.addr_summary -%></span>
					</div>
					<div class="col s12 m6 l6">
						<div class="capacity">
							<div class= "capacity_item">
								<img class="icons" src="/images/icons/icon_man.png">
								<div> 인원 <%- house_info.num_guest -%>명 </div>
							</div>
							<div class= "capacity_item">
								<img class="icons" src="/images/icons/icon_bed.png">
								<div> 침대 <%- house_info.num_bed -%>개 </div>
							</div>
							<div class= "capacity_item">
								<img class="icons" src="/images/icons/icon_bath.png">
								<div> 욕실 <%- house_info.num_bathroom -%>개 </div>
							</div>
						</div>
					</div>	
				</div>
			</div>
	    </section>

	    <section id="house_description" class="detail_section">
			<div class="row">
				<div class="col s12 m3 l3">
					<div class="title"> 기본 정보 </div>
				</div>
				<div class="col s12 m9 l9">
					<div class="content">
						<%- house_info.description -%>
						<!-- <p class="text"></p> -->
					</div>
				</div>
			</div>
	    </section>


<script>

	var card_top_offset = $('.card.search_bar').offset().top;

	// TODO: on load, width 100% is slow. 
	$(window).on('load scroll resize', function(e) {
		var currentScroll = $(window).scrollTop();
		var browserWidth = $(window).width() + 15;

		if(browserWidth < 870) {
			// console.log("hi")
			// $('#house_intro .card.search_bar').removeAttr("style");
			$('.card.search_bar').css({
				position: 'static',
				width: "100%",
				border: "none",
				padding: "0 60px"
			});					
		}

		else {

			if(currentScroll >= (card_top_offset - 130)) {
				$('.card.search_bar').css({
					position: 'fixed',
					top:'150px',
					right:$('.index_container.house_container').css("margin-right"),
					'z-index': '1',
					width: '300px',
					padding: "44px 30px",
					border: "1px solid #cdcdd1",
					"border-radius": "1px"
				});
			}

			else {
				$('.card.search_bar').css({
					position: 'absolute',
					top:'188px',
					width: '300px',					
					right:'0',
					padding: "44px 30px",
					border: "1px solid #cdcdd1",
					"border-radius": "1px"
				});
			}	
		}

		// if(e.type == "resize") {
		// 	if() {


		// 	}
		// }

		// else if(e.type == "scroll") {

			// if(currentScroll >= (card_top_offset - 130)) {
			// 	$('.card.search_bar').css({
			// 		position: 'fixed',
			// 		top:'130px',
			// 		right:$('.index_container.house_container').css("margin-right"),
			// 		'z-index': '1'
			// 	});
			// }

			// else {
				// if(browserWidth < 870) {
				// 	console.log("hi")
				// 	$('.card.search_bar').css({

				// 		// position: 'absolute',
				// 		// top:'168px',
				// 		// right:'0'
				// 	});					
				// }

				// else {
				// 	$('.card.search_bar').css({
				// 		position: 'absolute',
				// 		top:'168px',
				// 		right:'0'
				// 	});
				// }
			// }
		// }
	});


	$(function() {

		console.log("loaded")

		var checkin = flatpickr("#checkin_date_picker", {
			minDate: new Date(),
			// mode: "range", 
			// dateFormat: 'U',
			// altInput: true,
			// altFormat: 'Y-m-d',
			allowInput: true,
			onReady: function() {
			},
			onValueUpdate: function(dateObj, dateStr) {
				if(checkout) {
			        checkout.open();
				}
			}
		});

		var checkout = flatpickr("#checkout_date_picker", {
			minDate: new Date(),
			// dateFormat: 'U',
			// altInput: true,
			// altFormat: 'Y-m-d',
			allowInput: true, 
			onOpen: function() {
				var checkinDate = moment(checkin.input.value);

				var checkout_min = checkinDate.add(1, 'd').format("YYYY-MM-DD");
				this.set("minDate", checkout_min);
			},
			onValueUpdate: function(dateObj, dateStr) {
				// TODO: on input value gone, remove the price div 
				if(checkin.input.value) {
					var checkin_date = moment(checkin.input.value);
					var checkout_date = moment(this.input.value);

					// var checkout_date_sec = dateStr;
					var date_diff = checkout_date.diff(checkin_date, 'days')

					var daily_rate = <%- house_info.daily_rate -%>;
					var daily_rate_str = intToStringWithCommas(daily_rate);

					var total_rate = daily_rate * date_diff; 
					var total_rate_str = intToStringWithCommas(total_rate);

					$('.price').html("&#8361;" + daily_rate_str + " x " + date_diff + " 박" + "<div style='text-align: right; padding:5px 0'><b>합계: &#8361;" + total_rate_str + "</b></div>").css({"padding": '20px 20px 0', 'float':'right'});
				}
			}
		});

	});

// convert integer to comma separated (every 1000th) string
// ex: 19500 --> 19,500 
function intToStringWithCommas(num) {
	return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}


</script>

<!-- 	    <section id="house_price" class="detail_section">
			<div class="row">
				<div class="col s2 m2 l2">
					<div class="title"> 가격 정책 </div>
				</div>
				<div class="col s10 m10 l10">
					<div class="content">
						<p class="text">기본금액 (일시불 선불)</p>
						<p class="text text_thick">입주일 수 x 월세 + 추가로 사용하는 일 수 일일 계산 </p>
						<br>
						<p class="text">공과금 (일시불 선불)</p>
						<p class="text text_thick">&#8361; <%- house_info.utility_fee -%></p>
						<br>
						<p class="text">퇴실 청소비 (일시불 선불)</p>
						<p class="text text_thick">&#8361; <%- house_info.cleaning_fee -%></p>
					</div>
				</div>
			</div>
	    </section>
 -->
	    <section id="house_amenities" class="detail_section">
			<div class="row">
				<div class="col s12 m3 l3">
					<div class="title"> 편의 및 안전 </div>
				</div>
				<div class="col s12 m9 l9">
					<div class="content">
						<% for(var i=0; i< amenities_list.length;i++) { %> 
						<div class="col s6">
							<div class="amenity_item">
								<img class="icons" src="<%- amenities_list[i].icon_image -%>">
								<span><%- amenities_list[i].name -%></span>
							</div>
						</div>
						<% } %>
					</div>
					<!-- <div class="col s12 m4 l4"> -->
					<!-- </div> -->
				</div>
			</div>
	    </section>

	    <section id="house_policy" class="detail_section">
			<div class="row">
				<div class="col s12 m3 l3">
					<div class="title"> 이용규칙 </div>
				</div>
				<div class="col s12 m9 l9">
					<div class="content">
						<%- house_info.house_policy -%>

						<!-- <p class="text">기본금액 (일시불 선불)</p> -->
					</div>
				</div>
			</div>
	    </section>

	    <!-- house map -->
	    <section id="house_map" class="detail_section" style="width:100% !important">
	    	<div class="title"> 주변 지역 </div>
	    	<div id="map" style="height: 360px; width: 100%; margin: 10px 0">

	    	</div>
	    </section>

	    <section id="house_refund_policy" class="detail_section">
			<div class="row">
				<div class="col s12 m3 l3">
					<div class="title"> 환불 정책 </div>
				</div>
				<div class="col s12 m9 l9">
					<div class="content">
						<%- house_info.cancellation_policy -%>

						<!-- <p class="text">기본금액 (일시불 선불)</p> -->
					</div>
				</div>
			</div>
	    </section>
	    <section id="end_section" style="height: 30px">
	    </section>

    </div>

    <!-- footer -->
    <%- include('footer') -%>

	<script>
	var map;
	function initMap() {
		map = new google.maps.Map(document.getElementById('map'), {
			center: {lat: <%- house_info.latitude -%>, lng: <%- house_info.longitude -%>},
			zoom: 14,
			minZoom: 10,
			maxZoom: 17,
			disableDefaultUI: true
		});

		var home_icon = {
			url: "/images/icons/red_home_icon.png",
			scaledSize: new google.maps.Size(20,20),
            anchor: new google.maps.Point(10, 12),
		}

		var marker = new google.maps.Marker({
			position:{lat: <%- house_info.latitude -%>, lng: <%- house_info.longitude -%>},
			map:map,
			icon: home_icon
		});


		var circle = new google.maps.Circle({
            strokeColor: 'white',
            strokeOpacity: 0.9,
            strokeWeight: 2,
            fillColor: 'white',
            fillOpacity: 0.6,
            map: map,
            center: map.center,
            radius: 200
		});
	}

	$(function() {
		var swpier = new Swiper('.swiper-container', {
		  	pagination: '.swiper-pagination',
		  	paginationClickable:true,
		  	loop:true,
		  	centeredSlides:true,
		  	initialSlide:0,
		  	slidesPerView:3,
		  	spaceBetween:6,
		  	keyboardControl:true,
		  	nextButton: '.swiper-button-next',
		  	prevButton: '.swiper-button-prev',


	  	// slidesOffsetBefore: 10,
	// 		effect: 'coverflow',
		// coverflow: {
		// 	rotate: 0,
		// 	stretch: 0,
		// 	depth: 500,
		// 	modifier: 1,
		// 	slideShadows : false,
		// }

		});



		$('#star_rating').barrating({
			theme: 'fontawesome-stars-o',
			initialRating: eval('rating'),
			readonly: true
		})

	}); 
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDIKYpr3qNxWm2lC6VlVhoIFt3r1xy8dns&callback=initMap" async defer>
	</script>
  </body>
</html>